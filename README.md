перед загрузкой проверить все инн и телефоны тк, результат записать в V и F
при изменении значения в F будет добавляться массив адресов в V
т.е в DisplayData в handleChange надо еще вызывать поиск в бд адресов но названию тк, результат толко F записываем в LocFor через onCellChange
касательно V при его изменении тоже записываем результат в LocFor через onCellChange, но уже другим хендлером(выбранный адрес будет 1ым в массиве)

доработать handleUpload с учетом того, что надо обновить и V
сделать заглушки для V, типа для всех строк в V массив ['адрес_1','адрес_2']
как бы проверить новые строки - по значениям счетов, если новый, то в стобце Х прописать new. В то же время надо проверить вообще все значения стобцов, итог: либо new, del, change_NAME_COLUMN/или просто имя столбца
и тогда на странице имея классы закрышиваем красным номер п/п или счета, del - всю строку, а change_NAME_COLUMN - надо как-то закрасить именно ту колонку
это потом, а сейчас

самое главное сохранять в locFor F как строку, и V  как массив!!!
потом тупо соритровка и как-то по условиям наличия адреса подчеркивание строки

сейчас надо, если F изменено, то V очищать, т.е. Ф меняется далее запрос в бд если что-то находим заменям В, елси ничего не находим записываем в В пустой объект - делать это перед onCellChange(newData);

проблема с Забираем и Отвозим. Надо делать так: если есть файл txt, то читаем его; в нем с каждой новой строки новый забор. На страницу будут записаны значния по нулям, единственная ячейка, которая будет заполнена эта комментарий. Руками заполнятся тип отгрузки и адрес. Надо что-то прописывать в номере счета, например номер строки в txt файле. Также надо эту точку сохранять с бд. Для бд все Заборы и Отвозы будут под одним ИНН - н-р 999111999. Также надо, чтоб на фронте при обновлении не терялась эта строка. Для этого надо в Upload каждый раз делать еще и запрос к текстовому файлу и брать из него массив этих комментариев и прицеплять г готовому массиву асд+ом.

надо добавить еще три столбца - плательщик W, паллеты X, комментарий Y.
в Y автоматом при первом обновлении копировать данные их комментария.
в W массив, три значения - пусто, Т, Д. Без возможности редактировать
в X массив, только двузначные числа. Без возможности редактировать. Но пока пусть просто числовое значение

поработать с шапкой(закрепить области), затем переходим к серверу
серверную часть надо порпобовать сделать отдельным приложением. Потом если что можно слепить воедино

надо добавить еще один столбец Z - для сохранения номера счета, если 
МиО: несколько юр. лиц едут на один адрес
ТК: по нескольким юр. лицам грузополучатель один
счет, который копируется д.б. уже имеющимся определенным адресом
При Мо грузополучатели с внесенным счетом-ссылкой не перечеркиваются, при ТК - перечеркиваются.

(Кстати, в маршрутном листе в графе адрес будет, откорретированный адрес и получается тот адрес/город который будет указан при отправке, в доставках будет пустой, хотя пусть он будет не пустой, а будет содержать именно откорректорованный адрес, а в комменте коммент. А в тк тот адрес, который указан в 1С - город, но в комменте откорректрованный адрес(###). И т.к. нам потребуется кроме адреса еще и время работы ТК, тел., то мы их можем удидеть щелкнув по адресу терминала, а уже в маршрутный лист ### будет прописываться в самое НАЧАЛО откорректированного коммента
### - адрес из бд | коммент из бд/тк из бд/тел из бд/время из бд
получается в откорректированный коммент будет 
вот так вот не надо - ?доп. столбец, в котором динамически будет все кроме адрес из бд, т.е. коммент из бд/тк из бд/тел из бд/время из бд. В то же время проще/быстрее сделать один запрос вместо двух и выдать
адрес из бд * коммент из бд/тк из бд/тел из бд/время из бд
где * - это точка с запятой, до которой будет браться адрес для я.мар. Т.е. при записи адресов в бд ТК надо проверять обязательное отсутствие ; и если она есть заменять ее на запятую например.
На будущее вообще если такая ТК/доставка в бд уже есть, то надо записывать в скрытые столбцы долготу и широту и далее при формировании карты смотреть, если координаты есть, то их уже не надо определять по адресу, а можно сразу отрисовывать на карте, выигрывая при этом в скорости.)

с Z понятно, вроде есть смысл. Но как быть в тех случаях, когда надо изменить/зачеркнуть город доставки. Можно сделать так - если есть в столбце номер счета, который равен самому этому счету, то город черкаем. Если есть счет не равный самому счету, то зачеркивается
если в Z один счет, то
- если он равен самому счету, то черкаем город
- если он не равен самому счету, то черкаем название, а грузополучателя прописываем того, чей счет прописан
если с Z два счета, то 
- они не одинаковы, иначе ошибка красим все красным
    - один них точно д.б. равен самому счету, иначе ошибка, красим все красным
        - счет-ссылка д.б. в списке всех имеющихся счетов, иначе ошибка, красим все красным
            - черкаем и получателя(т.к. есть счет-ссылка) и город(самого счета)

формировать массив этих счетов по маске ##1-числа. Тут же на странице зачеркавать, то что следует. Т.е. в ф-цию передавать массив с двумя/одним счетом, она будет присваивать класс "cross-cell" в столбцах Получатель - E и Адрес - Q всех счетов по этому клинету. Определяем это по его ИНН, если ИНН нет, то по названию Получателя.
это сработает, но как решить сортировку - надо чтобы счет-икс с заполенной Z шел сразу за тем счетом-игрек, номер которого указан в счете-икс, и так со всеми ИНН счета-икс. Т.е. чтоб этот клиент прилипал снизу к счету, ссылка на который в Z у клиента. Получается после сорироваки по стобдцам надо проделывать такую процедуру с осторитованным массивом.
В итоге много закрученного кода.
Вариант:
Правый клик на названии или городе и черкаем ячейку. Отлично, но надо где-то хранить массив объектов с значениями row, column
[
    {
        row: 5,
        column: 3
    },    
    {
        row: 5,
        column: 4
    },
]
или

{
    value: '', 
    crossedCell: [
        {
         row: 5,
         column: 3
        },
        {
         row: 5,
         column: 4
        }
    ]
}

или проще 
{   
    crossedCellClient: true,
    crossedCellAddress: true,
    linkCell: 'МО1-000123'
}
пожалуй так, только можно убрать linkCell и брать его из осторированного массива из предыдущего объекта и Z тогда не понадобится. Тогда надо иметь возможность таскать руками строки. Итог: две задачи
1) Таскать руками
2) Клик правой кнопкой мыши!!!! можно просто клик с alt-ом 
?? 2) Доп. ключ Z с значением объект!!!! можно проще воткнуть в имеющийся ключ

получается черкаем -> перечеркиваются все ячейки столбца с этим ИНН(названием, если нет ИНН) - тут вопрос, т.к. могут быть исключения. Лучше черкать руками
в конце соритовки все счета с этим инн И перечернутые следуют за счетом-ссылкой и так для все перечернутых по названию поочереди!
Все, должно сработать, но тогда с таким Z
{   
    crossedCellClient: true,
    crossedCellAddress: true,
    linkCell: 'МО1-000123'
}
проверка - там где почеркано название должно быть значение счета-ссылки, иначе красное. Там где внесен счет-ссылка, он прописываетсы во всех Z с этим инн. Хотя могут быть исключения, поэтому так делать не надо, а надо черкать все по отдельности.

Если исключить linkCell, и оставить алгоритм такой - самая первая загрузка счетов происходит по сортировке по столбцам, далее таскаем все ручками. Если ячейки черкаем, то ?как ни крути? надо учитывать столбец Z в котором для соединения юр. лиц при доставки и ТК был основной счет-ссылка по которому будет разделение всех этих счетов. Самое простое для идентификации - это для всех почерканых в Z иметь счет-ссылку.

можно попробовать все-таки имея отсортированный массив в локалфоредж, при почерканых ячейках смотреть предыдущие непочерканные, т.е. так - отделяем только в том случае, если клинеты отличаются/ТК отличается/была Мио стала ТК или забираем/закончились почерканые - это будет применяться в маршрутных листах, т.е. столбец Z отображать нет необходимости.

задача: 
v - реализуем наличие ключа Z, не показываем его.
  - реализуем перетаскивание с сохранением очередности. 
  - реализуем перечеркивание.

итак, все красиво и вроде готово к взаимодействию с серверной частью. На что стоит обратить внимание
- разовую сортировку по инн и типу отгрзуки: МиО -> тк -> забираем. Остальное будем таскать руками.
- затем по всему массиву желательно определить адреса и ТК с терминалами. По МиО - для всех разных ИНН(если нет инн, то учитываем вместо него название), для ТК при наличии номера телефона в комменте. Тут важно при обновлении смотреть если Инн/клиент такой уже есть, то для него адрес не определять, но для начала лучше определять для всех новых счетов.
- возможно нужно сразу позаботиться о наличии полей в строках-объектах с координатами. Допустим в поля ключа Z - lat, lon. Т.е. всегда успеем, единственное, надо заранее позаботиться о их наличии в бд ТК и МиО. Тут интересный момент - как они будут меняться в зависимости от выбора адресов из селекта/инпута - можно все прописывать в V в конец после ;
- адрес из бд ; коммент из бд/тк из бд/тел из бд/время из бд ; координаты из бд

- что решено с адресами терминалов? - адрес из бд ; коммент из бд/тк из бд/тел из бд/время из бд ; координаты из бд

есть. Данные подготовлены и визуальная часть тоже. Остается 
- по действиям пользователя при onBlur обращаться к бд - и только на Типе отгрузки тк в конкретной ячейке.
- один раз по загрузке из хлс просматривать все комменты и с них выбирать телефоны, по ним обращения к бд с получением ТК и все инфы по ней ИЛИ
для простоты вывести кнопку "Определить ТК" и определить "Доставки"
 Дальше надо прикрутить кнопки StartMap и EndMap

 возможно для ТК лучше проверять только инфу в столбце L, смотрим сперва "тк ***" на like из массива всех тк из бд, если находим, то обращаемся к бд по названию этой тк. Если не находим, то собираем телефоны в массив и с ним обращаемся к бд. 
 И возможно для единичных распознаваний адресов надо сделать выпадающее меню (проверено, т.е. убирет желтый цвет со всей строки/определить ТК) по правому клику мыши "определить ТК", тогда при нахождении информации по названию или телефону в Y, удаляются старые адреса V и название ТК F и прописываются новые. 
 И последнее при смене ТК в столбце F задается вопрос пользователю и меняются адреса в V

 т.к. вся инфа о ТК не помещается в V, то надо прописывать ее в title td и менять при каждой смене филиала

 обновление seeds и миграции(предварительно удалив бд):
 npx knex migrate:latest
 npx knex seed:run

 поправлены ответы с ендпоинтов
 ------------
delivery/get-by-inn?inn=7722753969

 {
	"inn": "7722753969",
	"addresses": [
		"Константиново, Объездное ш., с03",
		"Мытищи"
	],
	"coordinates": [
		{
			"lat": 55.650898,
			"lng": 37.860358
		},
		{
			"lat": 55.650098,
			"lng": 37.860058
		}
	]
}

----------------
tk/get-by-numbers, с payload {"numbers": ["4957755530"]}

{
	"company": "тк Деловые Линии",
	"bid": 0,
	"marker": 0,
	"branches": [
		"г. Котельники, Дзержинское ш., 14",
		"Москва, ул. Подольских Курсантов, д. 17, к. 2"
	],
	"note": [
		"",
		""
	],
	"worktime": [
		"с 9-00 до 20-00",
		"с 00-00 до 24-00"
	],
	"coordinates": [
		{
			"lat": 55.659898,
			"lng": 37.862358
		},
		{
			"lat": 55.612345,
			"lng": 37.589012
		}
	]
}

Получается, в МиО в конце адреса надо будет через ; прописывать координаты. 

Для ТК появилась инфа для стилизации bid и marker запишем в ключ Z в bid и marker,
по этим булевым значениям будем красить ячейку

done - если нужно делать заявку, то тк жирным, если маркеровку, то тк красным - задействовать для стрилизации столбец Z
done - вытащить массив с названиями тк из бд, этот массив притянуть к инпуту в ТК
следовательно, лучше не при онблюре определять ТК, а при выборе из меню правого клика мыши, туда же запихнуть "проверенно, сбросить выделение", 
с предварительным контрольным вопросом в алерте. И при правом клике на МиО, тоже иметь возможность определять с бд доставку.
итак правый клик...
Найти адрес - просто сразу ищем по F(если начинается на тк и больше 4ех символов, т.е. ищем по эндпоинту name), если не находим, то ищем по Y, т.е. по энедпоинту numbers. Если МиО, то старый энпоинт.

решить с value и  defaultValue={row[header]}
поиск по name

1. допилить админ-панель для тк - удаление одного филиала
2. рассмотреть вариант работы с картой через localstorage
3. подготовить бд по доставкам


если ТК с одинаковыми названиями идут в строках не друг за другом(т.е. не сгрузппированы вручную), а раскиданы по странице, т.е. идут не друг за другом, то красить в красный, это надо лезть в sort
если есть список одинаковых ТК, то хотя бы у одной должен быть определен адрес, иначе красным

по-моему не добавились клиенты с нулевым ИНН, похоже надо закомментить в /api/upload-delivery
                if (rawINN.length !== 10 && rawINN.length !== 12) {
                    errors.push(`Строка ${index + 2}: Неверная длина ИНН`);

                    continue;
                }

ИНН может дублироваться, т.к. клиент может быть намеренно записан по-разному ООО "Аврора", ООО 'Аврора', а это значит, что ИНН не уникален, да и клиент не уникален. И тогда поиск должен быть сразу по двум параметрам. При совпадении обоих параметров, выдвать все его вдреса, даты и координаты.

1) если название клиента отсутствует(уже противоречит миграции), то искать по ИНН, т.е. с ИНН = 0, 1ый попавшийся клиент с инн = 0. Практически это не понадобится.
2) если инн отсутсвует, то искать по названию, по 1му совпадению
3) для Забрать/Отвести инн всегда будет один 91919191, и без названия клиента(оно не д.б. пустым), по нему выдывать все адреса. Понять какя будет запись в бд: { client: "Zabiraem/Otvozim", inn: [11111111, 122333232] addresses: ["адр1", "адр2"], history: [123123, 1237234], coordinates [{"lat": 0,"lng": 0},] }. Т.е. все записи, как для одного клиента.


1. решить тормоза на инпуте в F
т.к. исключу дублирования адресов при записи в бд, то нужно будет убрать исключение дубликатов адресов при получении данных по инн и клиенту из доставок

2. в меню по клику прав.мыши не "удалить строку", а "очистить адрес"


надо решить пробьлему повторения ТК
если ТК с одинаковыми названиями идут в строках не друг за другом(т.е. не сгрузппированы вручную), а раскиданы по странице, т.е. идут не друг за другом, то красить в красный, это надо лезть в sort
если есть список одинаковых ТК, то хотя бы у одной должен быть определен адрес, иначе красным
Можно решить с помощью наличия класса или просто стиля border-top. Т.е. если у одного названия ТК повторения свойства border-top более, чем 2 раза, то красим. Т.е. работать с отсортированным массивом объектов строк

решено - функция getGroupStatus вроде дописана. Далее
нумерацию точек делать так - разделение по адресам, т.е. номер метки на крате. После получения списка авто со счетами

для создания файла xls для ТрН надо иметь возможность выделять/красить/или ставить чекбокс те счета, по которым надо брать адреса для указания их в ТрН. Разделение по клиентам будет так же - при наличии адреса это одна ТрН по нескольким счетам.
Например если с одним адресом три счета
ООО "ПолимерТара"
ООО "ИНПАК Плюс"
ООО "ИНПАК Плюс"
то ТрН делается на верхний счет ООО "ПолимерТара". Если надо делать ТрН на двух контрагентов, то каждому надо присвоить адрес. И придется для всех ТрН всегда брать адреса из адреса в V. Если для некоторых клиентов важен полный адрес, то в БД хранить полный авдрес, например "143591, Московская область, г. Истра, д. Лобаново д. 256". Это актуально только для МиО. Для ТК - стандартно, для каждого контрагента своя ТрН и адрес без изменений из 1с.

для передачи данных на карту, надо сохранить всю инфу в local storage, как в файл json
	{
		"id":"33",
		"latitude":"55,737421",
		"longitude":"37,75311",
		"weight":"3344",
		"volume":"17,1",
		"pallet":"15",
		"info":"Москва, Перовское шоссе, д. 25 стр.1. тк Мейджик Транс, 8-800-100-44-44, (495) 232-48-11, (495) 989-17-61, с 9:00 до 20:00. Доставка всегда до Сургута ! ТК Мейджик Транс. 8495-232-48-11 За счет ГРУЗОПОЛУЧАТЕЛЯ. Заявка №  529202",
		"type":"тк Мейджик Транс",
		"address":"Москва, Перовское шоссе, д. 25 стр.1",
		"client":" ",
		"volumeInPallet":"16,7"
	},
а в карте загружать данные из ls. Причем надо учитывать сколько volumeInPallet - это когда для одного клиента суммируются все указанные паллеты в его счетах и весь объем, и так по каждому клиенту в этой ТК. Т.е. сумма pallet и сумма volumeInPallet, а volume - это общее и с паллетами и без.

Задача брать в Map эти данные из ls, т.е. как их там хранить - передача м/у вкладками решена через postMessage


18/04/2025
1) done! в хроме работет.. при забираем/отвозим - надо сразу предтсавлять адрес в таком виде "адрес; дата; 0,0"
в том случае, если сами прописываем адрес, то учитывать это, чтоб после проверки координат был такой формат "адрес; дата; 0,0"

2) в хроме работет, главное не иметь желтых полей?.. надо как-то избавиться от сортровки по алфавиту при F5

done! и еще почему-то ищутся все координаты для массива V, а не только V[0]
3) done !надо заменить updateCoordinatesInData - и учесть что в ней нет параметров!

4) done! разобраться с тем, что в скобках - неверно суммирует 
349 кг | 1.8 м3 | 3 пал ( 3 м3)


теперь задача как обратно получить массив массивов из элементов авто 
1,4
2,3,5
[[1,4], [2,3,5]]

допустим мы опять его получим через postMessage, а авто будем записывать в поле auto, поля-объекта Z. И тогда когда все эти данные будут на вкладке таблица, надо рендерить дополнительный элемент перед столбцом А, и в этом элементе отображать номер из Z. В A ничего запихнуть не можем, т.к. он заточен на сортироваку и просчет id исходя из наличия адреса. Или вводить доп. столбец, который рисовать до A.

далее надо будет формировать маршрутные листы. Тут две задачи - печать всех листов маршрутных и просмотр отдельно взятого лучше всего делать во фрейме. Видимо тоже через postMessage. Т.е. перед распечаткой смотрим во фрейме все авто, проверяем. После этого возможно лучше их сохранить в pdf, который пускать на печать.

или как вариант сохранять xls в том виде, в котором сейчас супер_маршруты
тогда имя объект sorteddata на листе xlsx, надо написать надстройки, чтобы
1) крайним правым столбцом(или в А) отобразить какой клиент по списку в какой авто (строка из txt - номер авто)
18,27
16,2,22
19,24,26
11,28,8
20,21,7
4
1,17,3
13,23,9
10,14
12,25
15,5,6
2) кнопка разноса на листы
1 и 2 - вариант: из надстройки щелкаем по кнопке, открывается шаблон типа супер маршруты и в него заносится вся инфа с разложением по листам. Тем самым мы уже имее лист FIO_GosNomer

остается проблема - как учитывать добавки и снятые с отгрузки счета. Вариант:
все-таки с карты сохранять авто в таблицу и из таблицы сохранять листы в xls. Это сложнее. Поэтому, клик на странице и 
1 - занести в бд новых клиентов или всех клиентов и zabiraem, кроме ТК
2 - записать объект на лист
3 - из надстроек клик и открывается шаблон с разнесенными авто по листам с диалоговым окном сохранить файл с названием дата след. рабочего дня
проблема - могут сохраниться не все доставки из-за добавок, т.е. добавки надо прогонять через таблицу в браузере? тогда уже с добавкой сохраняем в новый файл и из него добавляем в открытый шаблон (опять не то, т.к. неизвестно в какой авто едет добавка). Получается проще игнорировать сохранение добавок в бд и добавлять все в excel - минусы: не будет координат, адреса... Похоже придется идти путем посложнее - все делать в браузере, до оценки "Сортировка конечная". Но тогда самое сложное - прописывать ФИО и авто, это надо делать в xls. Опять получается, что надо сразу записывать в xls, остановимся на нем! И тогда добавки не регистрируюся в бд, а попадают в xls c полями Z_bid, Z_crossedCellAddress, Z_crossedCellClient, Z_marker равными false. Тут руками прописываем адрес, а в столбец Y закидываем L(сразу программно?).

Получается при сверке на обновления - проверяем на наличие новых счетов и прописываем их вниз, удаленные красим в красный. Этого будет достаточно. По желанию, можно при разносе на маршрутный лист, находить координаты (это будет происходить только в том случае, если поля координат пустые) и автоматом открывать браузер с точкой на карте(или просто формировать QR но оповещать - "проверь QR по_счету/с_адресом на карте"). 
Как вариант - при добавках смотреть базу из МиО и брать от туда адрес, чтоб не городить новых сомнительных адресов.

Итак, шаблон - два листа: FIO_GogNomer и Данные. Все закидывается в Данные (и уточняется название файла, под которым его нужно сохранить). 
На этом листе уже есть кнопки (элементы Active X)
1. Обновить счета, 2. Перенос авто, 3. ТрН и 4. Сортировка конечная.
Обновить - писал выше
Перенос создавать листы для каждой авто, сколько авто, столько и листов
ТрН - Готовить файл уже готовой структуры из двух листов Данные и ФИО
Сортровка конечная - тоже, готовый файл уже есть, его нужно собрать из двух листов

в ФИО кнопки
Перенос авто, Из подтверждений, Печать маршрутных, ?Прикрепить данные?, Сделать заявку, Печать с подложкой, Создать фильтр
т.е. все без изменений, кроме Прикрепить данные - по идее можно обойтись без нее.
И придется переписать Сделать заявку.
В Печать маршрутных и Печать с подложкой добавить генерацию QR.

сейчас обращение к серверу через прокси 
'http://localhost:8888'
